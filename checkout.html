<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daimara Stores | Checkout</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <style>
        :root {
            --primary: #e99d11;
            --dark: #111;
            --bg: #f5f5f5;
            --card: #ffffff;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, Helvetica, sans-serif; }
        body { background: var(--bg); font-size: 16px; padding-bottom: 20px; }

        /* NAVBAR */
        .navbar {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px 20px; background: var(--dark); color: #fff;
            position: fixed; top: 0; left: 0; width: 100%; z-index: 1000;
        }
        .logo { color: white; font-size: 20px; font-weight: bold; text-decoration: none; }
        .nav-icons { display: flex; align-items: center; gap: 15px; }
        .nav-icons a { color: #fff; font-size: 18px; transition: 0.3s; text-decoration: none; }
        .nav-icons a:hover { color: var(--primary); }

        /* CONTAINER */
        .container { width: 95%; max-width: 1000px; margin: 80px auto 30px auto; }
        h2, h3 { color: #333333; margin: 20px 0; text-align: center; }

        /* CART TABLE */
        .table-responsive { width: 100%; overflow-x: auto; background: #fff; border-radius: 8px; box-shadow: var(--shadow); margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; font-size: 14px; }
        th { background: #f9f9f9; color: #202020; }
        td img { width: 50px; height: 50px; object-fit: cover; border-radius: 4px; }

        /* TOTAL SECTION */
        .total-section { text-align: right; padding: 15px; background: #fff; border-radius: 8px; box-shadow: var(--shadow); margin-bottom: 30px; }
        .total-section div { margin: 5px 0; font-size: 16px; color: #27ae60; }
        .grand-total { font-size: 22px !important; font-weight: bold; color: black !important; margin-top: 10px !important; }

        /* CHECKOUT FORM */
        .checkout-form { background: #fff; padding: 25px; border-radius: 12px; box-shadow: var(--shadow); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px; color: #333; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
        
        .delivery-box { background: #f9f9f9; padding: 15px; border-radius: 8px; margin: 15px 0; }
        .checkbox-label { display: flex; align-items: center; gap: 10px; cursor: pointer; font-size: 14px; }
        .checkbox-label input { width: 18px; height: 18px; }

        #map-container { display: none; margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px; }
        .map-btn { display: inline-block; background: var(--dark); color: var(--primary); padding: 8px 15px; border-radius: 4px; text-decoration: none; font-size: 12px; font-weight: bold; margin-bottom: 10px; }
        
        .btn-group { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
        .btn-primary { background: var(--dark); color: var(--primary); padding: 15px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 16px; transition: 0.3s; }
        .btn-secondary { background: #e67e22; color: #fff; padding: 15px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 16px; transition: 0.3s; }
        .btn-primary:hover, .btn-secondary:hover { opacity: 0.9; }

        @media (max-width: 600px) {
            .container { padding: 0; }
            .checkout-form { padding: 15px; }
            th, td { padding: 8px; font-size: 12px; }
            .logo { font-size: 18px; }
        }

        /* SLIDER & PRODUCTS */
        .slider { width: 100%; aspect-ratio: 16/9; max-height: 300px; overflow: hidden; margin: 30px 0; border-radius: 2px; }
        .slide { display: none; height: 100%; }
        .slide img { width: 100%; height: 100%; object-fit: cover; }

        .products-preview { margin-top: 40px; }
        #random-products { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
        .product { background: #fff; padding: 10px; border-radius: 10px; box-shadow: var(--shadow); text-align: center; }
        .product img { width: 100%; height: 100px; object-fit: cover; border-radius: 6px; }
        .product h4 { font-size: 13px; margin: 8px 0; color: #333; }
        .product p { font-size: 14px; font-weight: bold; color: var(--primary); }
        .product button { width: 100%; margin-top: 8px; padding: 8px; border: none; border-radius: 4px; background: var(--dark); color: var(--primary); cursor: pointer; font-size: 11px; font-weight: bold; }

        /* FOOTER */
        .footer { background: none; color: #fff; padding: 15px; text-align: center; margin-top:40px;
      margin-bottom: -100px; }
        .footer p { color: black; font-size: 14px;font-weight: bold; }
    </style>
</head>
<body>

<nav class="navbar">
    <a href="index.html" class="logo">Daimara Stores</a>
    <div class="nav-icons">
        <a href="store.html" title="Store"><i class="fa fa-shopping-bag"></i></a>
        <a href="cart.html" title="Cart"><i class="fa fa-shopping-cart"></i></a>
    </div>
</nav>

<div class="container">
    <h2>Your Cart Items</h2>
    <div class="table-responsive">
        <table id="cartTable">
            <thead>
                <tr>
                    <th>Product</th>
                    <th>Details</th>
                    <th>Price</th>
                    <th>Qty</th>
                    <th>Subtotal</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="total-section">
        <div id="subtotalPrice">Subtotal: KES 0</div>
        <div id="deliveryFeeDisplay" style="display: none;">Delivery Fee: KES 0</div>
        <div id="totalPrice" class="grand-total">Total: KES 0</div>
    </div>

    <h3>Checkout Details</h3>
    <div class="checkout-form">
        <div class="form-group">
            <label>Full Name</label>
            <input type="text" id="name" placeholder="Enter your full name">
        </div>
        <div class="form-group">
            <label>Email Address</label>
            <input type="email" id="email" placeholder="Enter your email">
        </div>
        <div class="form-group">
            <label>Payment Method</label>
            <select id="paymentMethod">
                <option value="mpesa">M-Pesa</option>
            </select>
        </div>

        <div class="delivery-box">
            <label class="checkbox-label">
                <input type="checkbox" id="delivery-option" onchange="toggleMap()">
                <span id="deliveryLabelText">Add Delivery Fee (KES 0)</span>
            </label>

            <div id="map-container">
                <a href="https://www.google.com/maps" target="_blank" class="map-btn">
                    <i class="fas fa-map-marker-alt"></i> Open Google Maps
                </a>
                <p style="font-size: 12px; color: #666; margin-bottom: 5px;">Paste coordinates or link below:</p>
                <input type="text" id="location-coords" placeholder="e.g. -1.28, 36.82 or Maps link">
            </div>
        </div>

        <div class="btn-group">
            <button onclick="checkout()" class="btn-primary">Pay For Order(Now)</button>
            <button onclick="initiatePayAfterDelivery()" class="btn-secondary">Pay For Order(After Delivery)</button>
        </div>
    </div>

    <div class="slider" id="checkout-slider">
        <div class="slide"><img src="https://picsum.photos/1000/300?1"></div>
        <div class="slide"><img src="https://picsum.photos/1000/300?2"></div>
        <div class="slide"><img src="https://picsum.photos/1000/300?3"></div>
    </div>

    <section class="products-preview">
        <h2>Continue Shopping</h2>
        <div id="random-products"></div>
    </section>
</div>

<footer class="footer">
    <p>Copyright Â© 2026 Daimara Stores. All rights reserved.</p>
</footer>

<script src="data-manager.js"></script>
<script>
    (function() {
        const user = DataManager.getCurrentUser();
        if (!user) { alert("Please login to proceed"); window.location.href = "login.html"; }
    })();

    let cart = DataManager.getCart();

    function toggleMap() {
        const cb = document.getElementById('delivery-option');
        const mc = document.getElementById('map-container');
        mc.style.display = cb.checked ? 'block' : 'none';
        if (!cb.checked) document.getElementById('location-coords').value = '';
        updateTotals();
    }

    function updateTotals() {
        const subtotal = cart.reduce((a, b) => a + b.price * (b.qty || 1), 0);
        const config = DataManager.getSystemConfig();
        const df = config.deliveryFee;
        const addDelivery = document.getElementById('delivery-option').checked;
        
        document.getElementById('subtotalPrice').innerText = `Subtotal: KES ${subtotal.toLocaleString()}`;
        const dfd = document.getElementById('deliveryFeeDisplay');
        dfd.style.display = addDelivery ? 'block' : 'none';
        dfd.innerText = `Delivery Fee: KES ${df.toLocaleString()}`;
        
        const total = addDelivery ? subtotal + df : subtotal;
        document.getElementById('totalPrice').innerText = `Total: KES ${total.toLocaleString()}`;
    }

    function renderCart() {
        const tbody = document.querySelector('#cartTable tbody');
        tbody.innerHTML = '';
        cart.forEach(item => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><img src="${item.image || 'https://picsum.photos/50/50'}"></td>
                <td><strong>${item.name}</strong></td>
                <td>KES ${item.price.toLocaleString()}</td>
                <td>${item.qty || 1}</td>
                <td>KES ${(item.price * (item.qty || 1)).toLocaleString()}</td>
            `;
            tbody.appendChild(tr);
        });
        updateTotals();
    }

    document.addEventListener("DOMContentLoaded", () => {
        const user = DataManager.getCurrentUser();
        if (user) {
            document.getElementById('name').value = user.name || '';
            document.getElementById('email').value = user.email || '';
        }
        const config = DataManager.getSystemConfig();
        document.getElementById('deliveryLabelText').innerText = `Add Delivery (KES ${config.deliveryFee})`;
        renderCart();
        initSlideshow();
        renderRandom();

        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('deliveryFeePaid') === 'true') {
            const pending = JSON.parse(localStorage.getItem('pendingPayAfterDeliveryOrder'));
            if (pending) {
                const res = DataManager.processNewOrder({...pending, paymentStatus: 'unpaid', date: new Date().toISOString(), id: 'ORD-' + Math.random().toString(36).substr(2, 9).toUpperCase()});
                if (res.success) { DataManager.clearCart(); localStorage.removeItem('pendingPayAfterDeliveryOrder'); alert('Order placed! You will pay items on delivery.'); window.location.href = "profile.html"; }
            }
        }
    });

    function checkout() {
        const name = document.getElementById('name').value;
        const email = document.getElementById('email').value;
        const locationCoords = document.getElementById('location-coords').value;
        const addDelivery = document.getElementById('delivery-option').checked;

        if (!name || !email) { alert('Fill all fields'); return; }
        if (addDelivery && !locationCoords) { alert('Provide location'); return; }

        const config = DataManager.getSystemConfig();
        const subtotal = cart.reduce((a, b) => a + b.price * (b.qty || 1), 0);
        const total = addDelivery ? subtotal + config.deliveryFee : subtotal;

        const order = {
            id: 'ORD-' + Math.random().toString(36).substr(2, 9).toUpperCase(),
            items: cart,
            totalPrice: total,
            customerName: name,
            customerEmail: email,
            userId: DataManager.getCurrentUser().id,
            paymentMethod: document.getElementById('paymentMethod').value,
            deliveryLocation: addDelivery ? locationCoords : 'N/A',
            date: new Date().toISOString(),
            status: 'pending',
            paymentStatus: 'paid'
        };

        const res = DataManager.processNewOrder(order);
        if (res.success) { DataManager.clearCart(); alert('Order placed successfully!'); window.location.href = "profile.html"; }
    }

    function initiatePayAfterDelivery() {
        const cb = document.getElementById('delivery-option');
        const loc = document.getElementById('location-coords').value;
        if (!cb.checked || !loc) { alert("Select delivery and provide location coordinates."); return; }
        
        const name = document.getElementById('name').value;
        const email = document.getElementById('email').value;
        if (!name || !email) { alert('Fill all fields'); return; }

        const subtotal = cart.reduce((a, b) => a + b.price * (b.qty || 1), 0);
        const config = DataManager.getSystemConfig();
        
        const order = {
            items: cart,
            subtotal: subtotal,
            deliveryFee: config.deliveryFee,
            totalPrice: subtotal,
            grandTotal: subtotal,
            customerName: name,
            customerEmail: email,
            userId: DataManager.getCurrentUser().id,
            paymentMethod: 'Pay After Delivery',
            deliveryLocation: loc,
            paymentStatus: 'unpaid',
            status: 'pending'
        };

        localStorage.setItem('pendingPayAfterDeliveryOrder', JSON.stringify(order));
        alert(`Proceeding to pay delivery fee of KES ${config.deliveryFee}...`);
        window.location.href = `mpesa-payment.html?amount=${config.deliveryFee}&purpose=delivery-fee&orderId=temp-${Date.now()}`;
    }

    function initSlideshow() {
        const camp = DataManager.getAllCampaigns().filter(c => c.adType === 'slideshow' && c.targetPage === 'checkout');
        const slider = document.getElementById('checkout-slider');
        if (camp.length > 0) slider.innerHTML = camp.map(c => `<div class="slide"><img src="${c.media}"></div>`).join('');
        const slides = document.querySelectorAll('.slide');
        if (slides.length === 0) return;
        let idx = 0;
        function show() {
            slides.forEach(s => s.style.display = 'none');
            idx = (idx + 1) > slides.length ? 1 : idx + 1;
            slides[idx-1].style.display = 'block';
            setTimeout(show, 3000);
        }
        show();
    }

    function renderRandom() {
        const container = document.getElementById('random-products');
        const all = DataManager.getAllProducts();
        const flat = Object.keys(all).reduce((acc,k) => acc.concat(all[k]||[]), []);
        const shuffled = flat.sort(() => 0.5 - Math.random()).slice(0, 8);
        container.innerHTML = shuffled.map(p => `
            <div class="product">
                <img src="${p.image || 'https://picsum.photos/150/150'}">
                <h4>${p.name}</h4>
                <p>KES ${p.price}</p>
                <button onclick="addRec('${p.id}')">Add to Cart</button>
            </div>
        `).join('');
    }
    window.addRec = (id) => {
        const all = DataManager.getAllProducts();
        const flat = Object.keys(all).reduce((acc,k) => acc.concat(all[k]||[]), []);
        const p = flat.find(x => x.id === id);
        if (p) { DataManager.addToCart(p); alert('Added to cart!'); }
    }
</script>
</body>
</html>
