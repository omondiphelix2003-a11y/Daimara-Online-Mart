<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Daimara Online Mart | Checkout</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:Arial,sans-serif}
    body{background:#1F2937; font-size: 14px; padding-bottom: 100px; padding-top: 60px;}
    
    @media (min-width: 768px) {
      body{font-size: 16px; padding-top: 70px;}
    }
    
    @media (min-width: 1200px) {
      body{font-size: 22px; padding-top: 80px;}
    }

/* FOOTER */
.footer {
  background: #0a0a0a;
  color: white;
  padding: 30px 20px;
  text-align: center;
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  z-index: 1000;
}
.footer p {
  color: rgb(233, 157, 17);
}

/* PARA */
.para{
 color: #f5f5f5;
}

    /*.navbar{
    display:flex;align-items:center;justify-content:space-between;padding:-8px 40px;
    background:#111;color:#fff;  position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    background-color: #000000; /* Add your desired background color */
    z-index: 1000; /* Ensure it's on top of other elements */  
    .logo{color:rgb(233, 157, 17);font-size:25px;font-weight:bold}
    .navbar a{color:#fcfcfc;text-decoration:none;font-size: 25px;margin-left:15px;}*/


.navbar a:hover,
.navbar a.active {
  color: rgb(233, 157, 17);
}

@media (max-width: 768px) {
  .navbar a { font-size: 18px; }
}

    .container{padding:15px;max-width:100%;margin:auto; margin-top: -5px;overflow: hidden;}
    
    .table-wrapper {
      width: 100%;
      overflow-x: auto;
      overflow-y: auto;
      max-height: 600px;
      border: 1px solid #333;
      border-radius: 8px;
      margin-bottom: 20px;
      -webkit-overflow-scrolling: touch;
    }
    
    .table-wrapper::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    .table-wrapper::-webkit-scrollbar-track {
      background: #1F2937;
      border-radius: 8px;
    }
    
    .table-wrapper::-webkit-scrollbar-thumb {
      background: #11111188;
      border-radius: 8px;
    }
    
    .table-wrapper::-webkit-scrollbar-thumb:hover {
      background: #11111188;
    }
    
    .table-wrapper::-webkit-scrollbar-corner {
      background: #1F2937;
    }
    h2{text-align:center;font-size:28px;margin-bottom:20px;color: #000000;}
    h3{text-align:center;font-size:26px;margin-left: 0;color: #dadada;}
    table{min-width: 100%;border-collapse:collapse;margin-bottom:0px;color: rgb(233, 157, 17);font-size:14px;}
    table th, table td{padding:8px;border-bottom:1px solid #333;text-align:left;color: #aaa;}
    table img{width:60px;height:50px;object-fit:cover;border-radius:5px}
    .total{float:right;font-size:16px;margin-bottom:20px;color:#000000;}
    
    @media (min-width: 768px) {
      .container{padding:30px;}
      h2{font-size:24px;}
      h3{font-size:20px;}
      table{font-size:16px;}
      table th, table td{padding:12px;}
      table img{width:80px;height:60px;}
      .total{font-size:22px;}
    }
    
    @media (min-width: 1200px) {
      .container{padding:40px 30px;max-width:1000px;}
      h2{font-size:27px;}
      h3{font-size:27px; margin-left: 125px;}
      table{font-size:18px;}
      table th, table td{padding:15px;}
      table img{width:90px;height:70px;}
      .total{font-size:29px;}
    }
    .checkout-form{background:#1F2937;
       box-shadow: 0 5px 15px rgba(0, 0, 0, 0.329);
        transition: transform 0.3s;
       border:0.5px solid rgba(168, 163, 163, 0.363);
      margin-top: 100px;padding:20px;border-radius:10px;font-size: 16px;box-shadow:0 5px 15px rgba(0,0,0,.1)}
    .checkout-form input, .checkout-form select{width:100%;padding:12px;font-size: 16px;margin:10px 0;border:1px solid #333;border-radius:6px;background:#1F2937;color:#ffffff;}
    .checkout-form button{padding:12px 20px;font-size: 18px;background:#111;color:rgb(233, 157, 17);border:none;border-radius:6px;cursor:pointer;width:100%}

   .checkout-form:hover {
      transform:translateY(-4px);
      box-shadow:0 20px 25px -5px rgba(0,0,0,0.1);
      border-color:#e99d11;
    }
    

    
    @media (min-width: 768px) {
      .checkout-form{padding:40px 40px;}
      .checkout-form input, .checkout-form select{font-size: 18px;}
      .checkout-form button{font-size: 20px;}
    }
    
    @media (min-width: 1200px) {
      .checkout-form{padding:80px 80px; font-size: 18px;}
      .checkout-form input, .checkout-form select{font-size: 20px;}
      .checkout-form button{font-size: 22px;}
    }

    /* MAP BOX */
    #map-container {
      display: none;
      margin-top: 15px;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 8px;
      border: 1px solid #ddd;
    }
    #map {
      height: 300px;
      width: 100%;
      border-radius: 8px;
      margin-top: 10px;
      font-size: 27px;
    }
    .map-btn {
      background: #111;
      color: #e99d11;
      padding: 8px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 25px;
      margin-bottom: 10px;
    }

.shop-icon {
            position: relative;
            width: 45px;
            height: 45px;
            background-color: transparent;
            border: 3px solid rgb(233, 157, 17);
            border-radius: 4px;
            margin: 20px;
            left: -8px;
            top: -5px;
        }

        .shop-icon::before {
            content: '';
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 10px;
            height: 12px;
            border: 3px solid rgb(233, 157, 17);
            border-bottom: none;
            border-radius: 10px 10px 0 0;
        }

        .shop-icon::after {
            content: '';
            position: absolute;
            top: 10px;
            left: 8px;
            width: 14px;
            height: 2px;
            background-color: #ffffff;
            box-shadow: 0 6px 0 #a7884f;
        }



  </style>
  <style>
    /* SLIDER */
    .slider {
      position: relative;
      width: 100%;
      height: 200px;
      overflow: hidden;
      margin-top: 30px;
    }
    .slide {
      display: none;
    }
    .slide img {
      width: 100%;
      height: 400px;
      object-fit: cover;
    }

    /* RANDOM PRODUCTS */
    .products-preview {
      padding: 40px 30px;
      max-width: 1200px;
      margin: 0 auto;
    }
    .products-preview h2 {
      color: rgb(233, 157, 17);
      text-align: center;
      margin-bottom: 25px;
      font-size: 35px;
    }
    #random-products {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 20px;
    }
    
    @media (max-width: 1024px) {
      #random-products {
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        padding: 20px 15px;
      }
    }
    .product {
     background:#1F2937;
       box-shadow: 0 5px 15px rgba(0, 0, 0, 0.329);
        transition: transform 0.3s;
       border:0.5px solid rgba(168, 163, 163, 0.363);
      padding: 20px;
      border-radius: 10px;
      text-align: center;
    }

 
    .product:hover {
      transform:translateY(-4px);
      box-shadow:0 20px 25px -5px rgba(0,0,0,0.1);
      border-color:#e99d11;
    }

    .product img {
      width: 100%;
      height: 160px;
      object-fit: cover;
      border-radius: 8px;
    }
    .product h4 {
      font-size: 24px;
      margin: 10px 0;
      text-align: center;
      color: #000;
    }
    .product p {
      font-size: 22px;
      color: #000000;
      font-weight: bold;
    }
    .product button {
      margin-top: 10px;
      padding: 8px 15px;
      border: none;
      border-radius: 5px;
      background: #111;
      color: rgb(233, 157, 17);
      cursor: pointer;
      font-size: 20px;
    }
  </style>
</head>
<body>


<!-- NAVBAR -->
<nav class="navbar">
  <div class="logo">
           <!-- <a href="home.html" style="text-decoration: none; color: inherit; font-size: 25px;"><span>Checkout</span></a>-->
   </div>
  <!--<div class="nav-center">
    <a href="store.html"><div class="shop-icon"></div></a>
  </div>-->


</nav>

<footer class="footer">
  <p>Copyright Â© 2026 Daimara Online Mart.All rights reserved.</p>
</footer>

<div class="container">
  <h2>Your Cart</h2>
  <div class="table-wrapper">
    <table id="cartTable">
      <thead>
        <tr>
          <th>Product</th>
          <th>Details</th>
          <th>Price</th>
          <th>Quantity</th>
          <th>Subtotal</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <div class="total">
    <div id="subtotalPrice">Subtotal: KES 0</div>
    <div id="deliveryFeeDisplay" style="display: none; margin-top: 10px;">Delivery Fee: KES 70</div>
    <div id="totalPrice" style="margin-top: 10px; font-weight: bold; font-size: 31px;">Total: KES 0</div>
  </div>


  <h3>Checkout</h3>
  <div class="checkout-form">
    <input type="text" id="name" placeholder="Full Name" required />
    <input type="email" id="email" placeholder="Email" required />
    <label for="paymentMethod">Payment Method</label>
    <select id="paymentMethod" title="Payment Method" aria-label="Payment Method">
      <option value="mpesa">M-Pesa</option>
      <!--<option value="googlepay">Google Pay</option>
      <option value="card">Card</option>-->
    </select>
    
    <label for="warehouseSelect">Select Fulfillment Branch</label>
    <select id="warehouseSelect" title="Warehouse" aria-label="Warehouse" required onchange="populateStores()">
      <option value="">-- Select Branch --</option>
      <!-- Sub Warehouses will be injected here -->
    </select>

    <label for="storeSelect" style="margin-top: 15px;">Select Store</label>
    <select id="storeSelect" title="Store" aria-label="Store" required>
      <option value="">-- Select Store --</option>
      <!-- Stores will be injected here -->
    </select>
    <div style="margin: 15px 0; padding: 15px; background: #f9f9f9; border-radius: 6px;">
      <label for="delivery-option" style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
        <input type="checkbox" id="delivery-option" style="width: 18px; height: 18px; cursor: pointer;" onchange="toggleMap()">
        <span>Add Delivery (KES 70)</span>
      </label>

      <!-- Map Container -->
      <div id="map-container">
        <a href="https://www.google.com/maps/@-0.2802098,36.0567096,15z?entry=ttu&g_ep=EgoyMDI2MDIwNC4wIKXMDSoASAFQAw%3D%3D" target="_blank" rel="noopener noreferrer">
          <button type="button" class="map-btn"><i class="fas fa-map-marker-alt"></i> Open Google Maps to find your location</button>
        </a>
        <p style="font-size: 25px; color: #666; margin-top: 10px; margin-bottom: 5px;">Paste your location coordinates or link below:</p>
        <input type="text" id="location-coords" placeholder="Paste location here (e.g. -1.28, 36.82 or Google Maps link)" style="margin-top: 5px; font-size: 25px;">
      </div>
    </div>

   <button onclick="checkout()">Place Order</button>
    
    
  </div>
</div>

<!-- SLIDESHOW -->
<div class="slider">
  <div class="slide"><img src="https://picsum.photos/1200/400?1"></div>
  <div class="slide"><img src="https://picsum.photos/1200/400?2"></div>
  <div class="slide"><img src="https://picsum.photos/1200/400?3"></div>
</div>

<!-- RANDOM PRODUCTS -->
<section class="products-preview">
  <h2>Continue Shopping</h2>
  <div id="random-products"></div>
</section>

<script src="data-manager.js"></script>
<script src="navigation-helper.js"></script>
<script>
  // Authentication check - Inaccessible unless logged in
  (function() {
    const currentUser = DataManager.getCurrentUser();
    if (!currentUser) {
      alert("Please login or sign up to proceed with checkout.");
      window.location.href = "login.html";
    }
  })();

  let cart = DataManager.getCart();

  function toggleMap() {
    const deliveryCheckbox = document.getElementById('delivery-option');
    const mapContainer = document.getElementById('map-container');
    
    if (deliveryCheckbox.checked) {
      mapContainer.style.display = 'block';
    } else {
      mapContainer.style.display = 'none';
      document.getElementById('location-coords').value = '';
    }
    updateCheckoutTotal();
  }

  // Pre-fill user details if logged in
  document.addEventListener("DOMContentLoaded", function() {
    const currentUser = DataManager.getCurrentUser();
    if (currentUser) {
      document.getElementById('name').value = currentUser.name || '';
      document.getElementById('email').value = currentUser.email || '';
    }
    renderCart();
    populateWarehouses();
  });

  function getWarehouseData() {
    try {
      const data = localStorage.getItem('daimara_warehouse_data');
      return data ? JSON.parse(data) : { subWarehouses: [] };
    } catch(e) {
      return { subWarehouses: [] };
    }
  }

  function populateWarehouses() {
    const select = document.getElementById('warehouseSelect');
    const warehouseData = getWarehouseData();
    const subWarehouses = warehouseData.subWarehouses || [];
    
    subWarehouses.forEach(sw => {
      const option = document.createElement('option');
      option.value = sw.id;
      option.textContent = sw.name + (sw.stores && sw.stores.length > 0 ? ` (${sw.stores.length} stores)` : '');
      select.appendChild(option);
    });
  }

  function populateStores() {
    const warehouseId = document.getElementById('warehouseSelect').value;
    const storeSelect = document.getElementById('storeSelect');
    
    storeSelect.innerHTML = '<option value="">-- Select Store --</option>';
    
    if (!warehouseId) {
      return;
    }
    
    const warehouseData = getWarehouseData();
    const subWarehouses = warehouseData.subWarehouses || [];
    const warehouse = subWarehouses.find(sw => sw.id == warehouseId);
    
    if (!warehouse || !warehouse.stores || warehouse.stores.length === 0) {
      const option = document.createElement('option');
      option.value = '';
      option.textContent = 'No stores available';
      option.disabled = true;
      storeSelect.appendChild(option);
      return;
    }
    
    warehouse.stores.forEach(store => {
      const option = document.createElement('option');
      option.value = store.id;
      option.textContent = store.name + ' (' + store.location + ')';
      storeSelect.appendChild(option);
    });
  }

  function renderCart() {
    const tbody = document.querySelector('#cartTable tbody');
    tbody.innerHTML='';
    let subtotal=0;
    cart.forEach((item,index)=>{
      const qty = item.qty || 1;
      const itemSubtotal = item.price * qty;
      subtotal+=itemSubtotal;
      const imageSrc = item.image || 'image-placeholder.jpg';
      tbody.innerHTML+=`<tr>
        <td><img src="${imageSrc}" style="width:80px;height:60px;object-fit:cover;border-radius:5px;"></td>
        <td style="font-size:0.9em;">
          <p><strong>${item.name}</strong></p>
          ${item.subcategory ? `<p>Sub-Category: ${item.subcategory}</p>` : ''}
          ${item.sku ? `<p>SKU: ${item.sku}</p>` : ''}
          ${item.supplier ? `<p>Supplier: ${item.supplier}</p>` : ''}
          ${item.createdAt ? `<p>Added: ${item.createdAt}</p>` : ''}
        </td>
        <td>KES ${item.price}</td>
        <td><input type='number' min='1' value='${qty}' onchange='updateQuantity("${item.id}",this.value)'></td>
        <td>KES ${itemSubtotal}</td>
        <td><button onclick='removeItem("${item.id}")' style="padding:8px 12px;background:#e74c3c;color:white;border:none;border-radius:4px;cursor:pointer;">Remove</button></td>
      </tr>`;
    });
    document.getElementById('subtotalPrice').innerText = 'Subtotal: KES '+subtotal;
    updateCheckoutTotal();
  }

  function updateCheckoutTotal() {
    const deliveryCheckbox = document.getElementById('delivery-option');
    const subtotal = cart.reduce((a, b) => a + b.price * (b.qty || 1), 0);
    const deliveryFee = deliveryCheckbox.checked ? 70 : 0;
    const total = subtotal + deliveryFee;
    
    document.getElementById('deliveryFeeDisplay').style.display = deliveryCheckbox.checked ? 'block' : 'none';
    document.getElementById('totalPrice').innerText = 'Total: KES ' + total;
  }

  function updateQuantity(productId, qty){
    const result = DataManager.updateCartQuantity(productId, parseInt(qty));
    if(result && result.success){
      cart = DataManager.getCart();
      renderCart();
      updateCheckoutTotal();
    }
  }

  function removeItem(productId){
    const result = DataManager.removeFromCart(productId);
    if(result && result.success){
      cart = DataManager.getCart();
      renderCart();
      updateCheckoutTotal();
    }
  }

  function checkout(){
    const currentUser = DataManager.getCurrentUser();
    const name=document.getElementById('name').value;
    const email=document.getElementById('email').value;
    const paymentMethod=document.getElementById('paymentMethod').value;
    const warehouseId = document.getElementById('warehouseSelect').value;
    const storeId = document.getElementById('storeSelect').value;
    
    if(!name||!email){alert('Please fill all fields'); return;}
    if(!warehouseId){alert('Please select a branch for fulfillment'); return;}
    if(!storeId){alert('Please select a store for fulfillment'); return;}

    const subtotal = cart.reduce((a,b)=>a+b.price*(b.qty||1),0);
    const deliveryCheckbox = document.getElementById('delivery-option');
    const deliveryFee = deliveryCheckbox.checked ? 70 : 0;
    const totalPrice = subtotal + deliveryFee;

    const locationInput = document.getElementById('location-coords').value.trim();
    if (deliveryCheckbox.checked && !locationInput) {
      alert('Please paste your delivery location or link.');
      return;
    }

    const orderData = {
      items: cart,
      subtotal: subtotal,
      deliveryFee: deliveryFee,
      totalPrice: totalPrice,
      paymentMethod,
      warehouseId: warehouseId,
      storeId: storeId,
      customer: { 
        name, 
        email, 
        phone: currentUser ? currentUser.phone : '' 
      },
      customerName: name,
      customerPhone: currentUser ? currentUser.phone : '',
      deliveryLocation: deliveryCheckbox.checked ? locationInput : null
    };

    // Simulate backend call
    console.log('Placing order...', orderData);
    
    // In a real app, you'd fetch here
    /*
    fetch('http://localhost:5000/api/orders',{ 
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'Authorization':'Bearer '+localStorage.getItem('token')
      },
      body:JSON.stringify(orderData)
    })
    */

    // Simulate successful response
    const data = {
      success: true,
      orderId: 'ORD-' + Date.now(),
      totalPrice: totalPrice
    };

    // Save to DataManager orders
    const newOrder = {
      ...orderData,
      id: data.orderId,
      date: new Date().toISOString(),
      status: 'pending',
      userId: currentUser ? currentUser.id : 'guest',
      grandTotal: totalPrice // Align with admin-manager.html expectation
    };
    
    const allOrders = DataManager.getAllOrders() || [];
    allOrders.push(newOrder);
    DataManager.saveOrders(allOrders);
    
    console.log('Order saved successfully:', newOrder);
    console.log('All orders after save:', DataManager.getAllOrders());

    // REDUCE STOCK FROM SELECTED STORE
    cart.forEach(item => {
      const qty = item.qty || 1;
      // Deduct from the specific store's inventory
      const result = DataManager.deductFromStoreInventory(warehouseId, storeId, item.id, item.name, qty);
      if (!result.success) {
        console.warn(`Failed to deduct ${item.name} from store: ${result.message}`);
      }
    });

    // Generate Invoice
    const invoiceData = {
      orderId: data.orderId,
      customerInfo: {
        name: name,
        email: email,
        phone: currentUser ? currentUser.phone : ''
      },
      items: cart,
      subtotal: subtotal,
      tax: subtotal * 0.16, // 16% VAT
      shipping: deliveryFee,
      total: totalPrice
    };
    DataManager.addInvoice(invoiceData);

    localStorage.setItem('mpesaOrder', JSON.stringify({
      orderId: data.orderId,
      total: totalPrice,
      items: cart
    }));

    if (paymentMethod === 'mpesa') {
      window.location.href = "mpesa-payment.html";
    } else {
      alert('Order placed successfully! Order ID: ' + data.orderId);
      DataManager.clearCart();
      window.location.href = "index.html";
    }
  }


  renderCart();

  // Add delivery option listener
  const deliveryCheckbox = document.getElementById('delivery-option');
  if (deliveryCheckbox) {
    deliveryCheckbox.addEventListener('change', updateCheckoutTotal);
  }

  // SLIDER
  let sliderIndex = 0;
  const slides = document.querySelectorAll('.slide');
  function showSlides() {
    slides.forEach(s => s.style.display = 'none');
    sliderIndex = (sliderIndex + 1) > slides.length ? 1 : sliderIndex + 1;
    if (slides[sliderIndex - 1]) slides[sliderIndex - 1].style.display = 'block';
    setTimeout(showSlides, 3000);
  }
  showSlides();

  // RANDOM PRODUCTS
  (function() {
    const rndContainer = document.getElementById('random-products');
    function getAllFlattened() {
      const all = DataManager.getAllProducts();
      return Object.keys(all).reduce((acc, k) => acc.concat(all[k] || []), []);
    }

    window.addToCartById = function(id) {
      const prod = getAllFlattened().find(p => p.id === id);
      if (!prod) { alert('Product not found'); return; }
      DataManager.addToCart(prod);
      cart = DataManager.getCart();
      renderCart();
      updateCheckoutTotal();
      alert('Added to cart');
    };

    function renderRandom(n = 8) {
      if (!rndContainer) return;
      const all = getAllFlattened();
      if (all.length === 0) { rndContainer.innerHTML = '<p>No products available yet.</p>'; return; }
      const shuffled = all.slice().sort(() => 0.5 - Math.random()).slice(0, n);
      rndContainer.innerHTML = '';
      shuffled.forEach(p => {
        const img = p.image || 'https://picsum.photos/300/200';
        rndContainer.innerHTML += `
          <div class="product">
            <img src="${img}">
            <h4>${p.name}</h4>
            <p>Ksh ${p.price}</p>
            <button onclick="addToCartById('${p.id}')">Add to Cart</button>
          </div>`;
      });
    }
    renderRandom(8);
  })();
</script>
</body>
</html>
