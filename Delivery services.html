<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Daimara Delivery Services</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<style>
:root{
  --primary:rgb(233, 157, 17);
  --accent:#2563eb;
  --bg:#f4f6f9;
  --card:#ffffff;
}

body{
  margin:0;
  font-family:Arial, Helvetica, sans-serif;
  background:var(--bg);
}

.topbar{
  background:var(--primary);
  color:rgb(0, 0, 0);
  padding:16px 24px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.container{
  padding:24px;
}

.grid{
  display:grid;
  grid-template-columns: repeat(auto-fit,minmax(220px,1fr));
  gap:20px;
  margin-bottom:25px;
}

.card{
  background:var(--card);
  border-radius:12px;
  padding:20px;
  box-shadow:0 6px 15px rgba(0, 0, 0, 0.904);
}

.section{
  margin-top:30px;color: #064e1f;
}

.table-container {
  max-width: 100%;
  overflow-x: auto;
  overflow-y: auto;
  max-height: 500px;
  border-radius: 12px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}

.table{
  width:100%;
  border-collapse:collapse;
  background:white;
  border-radius:12px;
  overflow:hidden;
}

.table th, .table td{
  padding:12px;
  border-bottom:1px solid #eee;
  text-align:left;
  color: black;
}

.action-btn{
  border:none;
  padding:8px 12px;
  border-radius:6px;
  cursor:pointer;
  color:white;
}

.dispatch{background:#2564ebd8}
.delivered{background:#16a34ae0}

#reader{
  width:100%;
  max-width:400px;
  margin-top:20px;
  border-radius: 5px;
}

.scan-result{
  margin-top:15px;
  font-weight:bold;
}

/* MODAL STYLES */
.modal {
  display: none;
  position: fixed;
  z-index: 2000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.8);
  align-items: center;
  justify-content: center;
  padding: 20px;
}
.modal-content {
  background: #fff;
  padding: 30px;
  border-radius: 12px;
  max-width: 600px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  position: relative;
}
.close-modal {
  position: absolute;
  top: 15px;
  right: 15px;
  font-size: 24px;
  cursor: pointer;
  color: #666;
  border: none;
  background: none;
}
.receipt { color: #333; }
.receipt-header { text-align: center; margin-bottom: 20px; border-bottom: 2px dashed #ddd; padding-bottom: 15px; }
.receipt-header h1 { color: var(--primary); margin: 0; }
.receipt-info { margin-bottom: 20px; line-height: 1.6; }
.receipt-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
.receipt-table th { text-align: left; border-bottom: 1px solid #eee; padding: 10px 0; }
.receipt-table td { padding: 10px 0; border-bottom: 1px solid #f9f9f9; }
.receipt-total { text-align: right; font-size: 20px; font-weight: bold; border-top: 2px solid #333; padding-top: 10px; }
.dispatch-confirm-btn {
  display: block;
  width: 100%;
  margin-top: 20px;
  padding: 15px;
  background: var(--accent);
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: bold;
  font-size: 18px;
}

</style>
</head>
<body>

<div class="topbar">
  <h2>Daimara Delivery Services</h2>
</div>

<!-- DETAILS MODAL -->
<div id="details-modal" class="modal">
  <div class="modal-content">
    <button class="close-modal" onclick="closeModal()">&times;</button>
    <div id="modal-body"></div>
  </div>
</div>

<div class="container">

  <!-- SUMMARY -->
  <div class="grid">
    <div class="card">
      <h3>Orders Ready for Dispatch</h3>
      <strong id="summary-ready">0</strong>
    </div>
    <div class="card">
      <h3>Out for Delivery</h3>
      <strong id="summary-out">0</strong>
    </div>
    <div class="card">
      <h3>Delivered Today</h3>
      <strong id="summary-delivered">0</strong>
    </div>
    <div class="card" style="background: #16a34a; color: white;">
      <h3>Total Profit</h3>
      <strong id="summary-profit">KES 0</strong>
    </div>
  </div>

  <!-- DISPATCH LIST -->
  <div class="section">
    <h2>Dispatch Packed Orders</h2>
    <div class="table-container">
      <table class="table">
        <thead>
          <tr>
            <th>Order ID</th>
            <th>Client</th>
            <th>Destination</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>#DM2042</td>
            <td>Peter Otieno</td>
            <td>Karen</td>
            <td>Packed</td>
            <td><button class="action-btn dispatch">Send to Delivery</button></td>
          </tr>
          <tr>
            <td>#DM2043</td>
            <td>Grace Njeri</td>
            <td>Kilimani</td>
            <td>Out for Delivery</td>
            <td><button class="action-btn delivered">Mark Delivered</button></td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- QR CODE SCANNER -->
  <div class="section">
    <h2>Scan Client Receipt QR Code</h2>
    <p>Scan the client's receipt QR code to confirm delivery.</p>
    <div id="reader"></div>
    <div class="scan-result" id="result">Waiting for scan...</div>
  </div>

</div>

<script src="data-manager.js"></script>
<script>
function checkAccess() {
  const user = DataManager.getCurrentUser();
  if (!user) {
    alert("Please login first.");
    window.location.href = "login.html";
    return false;
  }

  const urlParams = new URLSearchParams(window.location.search);
  const viewUserEmail = urlParams.get('viewUserEmail');

  // Allow admin to view any delivery page if they have the email param
  if (user.role === 'admin' && viewUserEmail) {
    return true;
  }

  if (user.role !== 'delivery') {
    alert("Access denied. This page is for delivery personnel only.");
    window.location.href = "index.html";
    return false;
  }
  return true;
}

// Get the email to view (for admin impersonation)
const urlParams = new URLSearchParams(window.location.search);
const viewUserEmail = urlParams.get('viewUserEmail');

if (checkAccess()) {
  document.addEventListener('DOMContentLoaded', () => {
    renderDeliveryData();
    // Auto refresh every 30 seconds to catch new assignments
    setInterval(renderDeliveryData, 30000);
  });
}

function renderDeliveryData() {
  const orders = DataManager.getScopedData('delivery_orders', [], viewUserEmail);
  const earnings = DataManager.getScopedData('delivery_earnings', { total: 0 }, viewUserEmail);
  
  const today = new Date().toLocaleDateString();
  const summary = {
    ready: orders.filter(o => o.status === 'assigned' || o.status === 'Packed').length,
    out: orders.filter(o => o.status === 'Out for Delivery').length,
    delivered: orders.filter(o => {
      const isCompleted = o.status === 'completed' || o.status === 'Delivered';
      const isToday = o.date && new Date(o.date).toLocaleDateString() === today;
      return isCompleted && isToday;
    }).length,
    profit: earnings.total || 0
  };

  // Update Summary
  document.getElementById('summary-ready').innerText = summary.ready;
  document.getElementById('summary-out').innerText = summary.out;
  document.getElementById('summary-delivered').innerText = summary.delivered;
  document.getElementById('summary-profit').innerText = `KES ${summary.profit.toLocaleString()}`;

  // Update Table
  const tbody = document.querySelector('.table tbody');
  tbody.innerHTML = orders.map(o => `
    <tr>
      <td>${o.id}</td>
      <td>${o.client}</td>
      <td><a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(o.destination)}" target="_blank" style="color:var(--accent); text-decoration:none;"><i class="fas fa-map-marker-alt"></i> ${o.destination}</a></td>
      <td>${o.status}</td>
      <td>
        ${(o.status === 'assigned' || o.status === 'Packed') ? `<button class="action-btn dispatch" onclick="viewReceipt('${o.id}')">Send to Delivery</button>` : ''}
        ${o.status === 'Out for Delivery' ? `<button class="action-btn delivered" onclick="updateStatus('${o.id}', 'completed')">Mark Delivered</button>` : ''}
        ${(o.status === 'completed' || o.status === 'Delivered') ? '<span style="color:green">Completed</span>' : ''}
      </td>
    </tr>
  `).join('') || '<tr><td colspan="5" style="text-align:center">No active delivery assignments</td></tr>';
}

function updateStatus(id, newStatus) {
  const result = DataManager.updateOrderStatus(id, newStatus);
  if (result.success) {
    renderDeliveryData();
    closeModal();
  }
}

function viewReceipt(orderId) {
  const orders = DataManager.getScopedData('delivery_orders', [], viewUserEmail);
  const dOrder = orders.find(o => o.id === orderId);
  if (!dOrder) return alert("Order not found");

  // Get global order for full details
  const allOrders = DataManager.getAllOrders();
  const order = allOrders.find(o => o.id === orderId);
  if (!order) return alert("Order full details not found");

  const body = document.getElementById('modal-body');
  const items = order.items || order.products || [];

  body.innerHTML = `
    <div class="receipt">
      <div class="receipt-header">
        <h1>DAIMARA ONLINE MART</h1>
        <p>Delivery Dispatch Receipt</p>
      </div>
      <div class="receipt-info">
        <p><strong>Order ID:</strong> ${order.id}</p>
        <p><strong>Customer:</strong> ${order.customerName || order.customer?.name}</p>
        <p><strong>Phone:</strong> ${order.customerPhone || order.customer?.phone || 'N/A'}</p>
        <p><strong>Destination:</strong> <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(order.deliveryLocation || dOrder.destination)}" target="_blank" style="color:var(--accent); text-decoration:none;"><i class="fas fa-map-marker-alt"></i> ${order.deliveryLocation || 'N/A'}</a></p>
        <p><strong>Date:</strong> ${new Date(order.date).toLocaleString()}</p>
      </div>
      <table class="receipt-table">
        <thead>
          <tr>
            <th>Item</th>
            <th style="text-align:center;">Qty</th>
          </tr>
        </thead>
        <tbody>
          ${items.map(item => `
            <tr>
              <td>${item.name}</td>
              <td style="text-align:center;">${item.qty || item.quantity || 1}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
      <div class="receipt-total">
        Total: KES ${(order.grandTotal || order.totalPrice || 0).toLocaleString()}
      </div>
      <button class="dispatch-confirm-btn" onclick="updateStatus('${order.id}', 'Out for Delivery')">
        <i class="fas fa-truck"></i> Confirm Dispatch & Start Delivery
      </button>
    </div>
  `;
  document.getElementById('details-modal').style.display = 'flex';
}

function closeModal() {
  document.getElementById('details-modal').style.display = 'none';
}

// Close on background click
window.onclick = function(event) {
  const modal = document.getElementById('details-modal');
  if (event.target == modal) closeModal();
}

function onScanSuccess(decodedText) {
  const resultDiv = document.getElementById("result");
  const orders = DataManager.getScopedData('delivery_orders');
  
  // Try to find the order in the delivery person's assigned list
  // Handle both with and without '#' prefix
  const dOrder = orders.find(o => o.id === decodedText || o.id === '#' + decodedText);
  
  if (!dOrder) {
    resultDiv.innerText = "Error: QR Code (" + decodedText + ") does not match any assigned order!";
    resultDiv.style.color = "red";
    alert("Error: Scanned QR code does not match the receipt details for your assigned orders.");
    return;
  }

  // If found, update status
  const result = DataManager.updateOrderStatus(dOrder.id, 'completed');
  if (result.success) {
    resultDiv.innerText = "Success: Order " + dOrder.id + " confirmed and marked as completed!";
    resultDiv.style.color = "green";
    renderDeliveryData();
    alert("Order " + dOrder.id + " marked as completed via scan!");
  } else {
    resultDiv.innerText = "Error: Failed to update order status.";
    resultDiv.style.color = "red";
    alert("Failed to update order status. Please try again.");
  }
}

function onScanError(error) {
  // console.warn(error);
}

let html5QrcodeScanner = new Html5QrcodeScanner(
  "reader", { fps: 10, qrbox: 250 }
);
html5QrcodeScanner.render(onScanSuccess, onScanError);
</script>

</body>
</html>