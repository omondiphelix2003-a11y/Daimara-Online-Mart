<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Daimara Executive Dispatch</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root{
  --primary:rgb(233, 157, 17);
  --accent:#2563eb;
  --bg:#f4f6f9;
  --card:#ffffff;
}

body{
  margin:0;
  font-family:Arial, Helvetica, sans-serif;
  background:var(--bg);
}

.topbar{
  background:var(--primary);
  color:rgb(0, 0, 0);
  padding:16px 24px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.topbar h1{
  margin:0;
  font-size:20px;
}

.container{
  padding:24px;
}

.grid{
  display:grid;
  grid-template-columns: repeat(auto-fit,minmax(220px,1fr));
  gap:20px;
  margin-bottom:25px;
}

.card{
  background:var(--card);
  border-radius:12px;
  padding:20px;
  box-shadow:0 6px 15px rgba(0, 0, 0, 0.911);
}

.section{
  margin-top:30px;
  color:#064e1f ;
}

.table{
  width:100%;
  border-collapse:collapse;
  background:white;
  border-radius:12px;
  overflow:hidden;
}

.table th, .table td{
  padding:12px;
  border-bottom:1px solid #eee;
  text-align:left;
  color: black;
}

.action-btn{
  border:none;
  padding:8px 12px;
  border-radius:6px;
  cursor:pointer;
  color:rgb(0, 0, 0);
}

.send{background:#13b34d}
.dispatch{background:#0a3ca8e7}

.status{
  padding:5px 10px;
  border-radius:20px;
  font-size:12px;
  font-weight:bold;
}

.pending{background:#fde68a}
.sent{background:#8ebdf7}
.dispatched{background:#87f5ae}

.blurry-text {
  filter: blur(5px);
  cursor: not-allowed;
  user-select: none;
  transition: filter 0.3s;
}

.modal {
  display: none;
  position: fixed;
  z-index: 2000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  align-items: center;
  justify-content: center;
}

.modal-content {
  background: white;
  padding: 30px;
  border-radius: 12px;
  max-width: 600px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
  position: relative;
  color: black;
}

.close-modal {
  position: absolute;
  top: 15px;
  right: 15px;
  font-size: 30px;
  cursor: pointer;
  color: #777;
}

.hidden {
  display: none !important;
}

</style>
</head>
<body>

<div class="topbar">
  <h1>Daimara Executive Dispatch Panel</h1>
</div>

<div class="container">

  <!-- SUMMARY -->
  <div class="grid">
    <div class="card" onclick="showAwaitingPackaging()" style="cursor: pointer; transition: 0.3s;">
      <h3>Orders Awaiting Packaging</h3>
      <strong id="awaitingCount">0</strong>
    </div>
    <div class="card">
      <h3>Ready for Dispatch</h3>
      <strong id="readyCount">0</strong>
    </div>
    <div class="card">
      <h3>Dispatched Today</h3>
      <strong id="dispatchedCount">0</strong>
    </div>
    <div class="card">
      <h3>Urgent Deliveries</h3>
      <strong id="urgentCount">0</strong>
    </div>
  </div>

  <!-- PACKAGING & DISPATCH QUEUE -->
  <div class="section">
    <h2>Packaging & Dispatch Queue</h2>
    <table class="table">
      <thead>
        <tr>
          <th>Order ID</th>
          <th>Client</th>
          <th>Products</th>
          <th>Destination</th>
          <th>Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="packagingQueueTable">
      </tbody>
    </table>
  </div>

</div>

<!-- AWAITING PACKAGING MODAL -->
<div id="packagingModal" class="modal">
  <div class="modal-content">
    <span class="close-modal" onclick="closePackagingModal()">&times;</span>
    <h2>Orders Awaiting Packaging</h2>
    <table class="table">
      <thead>
        <tr>
          <th>Order ID</th>
          <th>Products</th>
          <th>Amount</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="awaitingOrdersTable">
      </tbody>
    </table>
  </div>
</div>

<!-- ORDER DETAILS MODAL -->
<div id="orderDetailsModal" class="modal">
  <div class="modal-content">
    <span class="close-modal" onclick="closeOrderDetailsModal()">&times;</span>
    <div id="orderDetailsContent"></div>
  </div>
</div>

<script src="data-manager.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  if (typeof DataManager === 'undefined') {
    console.error('DataManager not loaded');
    return;
  }
  console.log('DataManager loaded successfully');
  console.log('Initial orders:', DataManager.getAllOrders());
  updateOrderCounts();
  renderPackagingQueue();
  
  setInterval(() => {
    updateOrderCounts();
    renderPackagingQueue();
  }, 2000);
  
  window.addEventListener('storage', (e) => {
    if (e.key === 'ecommerce_orders') {
      console.log('Orders updated from another tab/window');
      updateOrderCounts();
      renderPackagingQueue();
    }
  });
});

window.addEventListener('focus', () => {
  updateOrderCounts();
  renderPackagingQueue();
});

function updateOrderCounts() {
  const orders = DataManager.getAllOrders() || [];
  
  const awaitingOrders = orders.filter(o => o.status === 'pending').length;
  const packagingOrders = orders.filter(o => o.status === 'in-packaging').length;
  const dispatchedOrders = orders.filter(o => o.status === 'in-transit').length;
  const completedOrders = orders.filter(o => o.status === 'completed').length;
  
  console.log('Order counts - Awaiting:', awaitingOrders, 'Packaging:', packagingOrders, 'Dispatched:', dispatchedOrders);
  
  const awaitingCountElement = document.getElementById('awaitingCount');
  const readyCountElement = document.getElementById('readyCount');
  const dispatchedCountElement = document.getElementById('dispatchedCount');
  
  const previousAwaitingCount = parseInt(awaitingCountElement.textContent) || 0;
  
  awaitingCountElement.textContent = awaitingOrders;
  readyCountElement.textContent = packagingOrders;
  dispatchedCountElement.textContent = dispatchedOrders;
  
  if (awaitingOrders > previousAwaitingCount) {
    console.log('New orders received!');
    showAwaitingPackagingAuto();
  }
}

function showAwaitingPackaging() {
  populateAwaitingOrdersModal();
  document.getElementById('packagingModal').style.display = 'flex';
}

function showAwaitingPackagingAuto() {
  populateAwaitingOrdersModal();
  const modal = document.getElementById('packagingModal');
  modal.style.display = 'flex';
  console.log('Auto-opened Orders Awaiting Packaging modal');
}

function populateAwaitingOrdersModal() {
  const orders = DataManager.getAllOrders() || [];
  const awaitingOrders = orders.filter(o => o.status === 'pending');
  
  const tbody = document.getElementById('awaitingOrdersTable');
  tbody.innerHTML = '';
  
  console.log('All Orders:', orders);
  console.log('Awaiting Orders:', awaitingOrders);
  
  if (awaitingOrders.length === 0) {
    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #666;">No orders awaiting packaging</td></tr>';
    return;
  }
  
  awaitingOrders.forEach(order => {
    const itemsText = order.items ? order.items.map(i => `${i.name} (${i.qty || 1})`).join(', ') : 'N/A';
    const amount = order.grandTotal || order.totalPrice || 0;
    
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${order.id || 'N/A'}</td>
      <td>${itemsText}</td>
      <td>KES ${amount.toLocaleString()}</td>
      <td><button class="action-btn send" onclick="viewOrderDetails('${order.id}')">View Details</button></td>
    `;
    tbody.appendChild(row);
  });
}

function closePackagingModal() {
  document.getElementById('packagingModal').style.display = 'none';
}

function renderPackagingQueue() {
  const orders = DataManager.getAllOrders();
  const packagingOrders = orders.filter(o => o.status === 'in-packaging');
  
  const tbody = document.getElementById('packagingQueueTable');
  tbody.innerHTML = '';
  
  if (packagingOrders.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666;">No orders in packaging queue</td></tr>';
    return;
  }
  
  packagingOrders.forEach(order => {
    const itemsText = order.items ? order.items.map(i => `${i.name} (${i.qty || 1})`).join(', ') : 'N/A';
    const destination = order.deliveryLocation || 'Pickup';
    
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${order.id || 'N/A'}</td>
      <td><span class="blurry-text">${order.customerName || 'N/A'}</span></td>
      <td>${itemsText}</td>
      <td>${destination}</td>
      <td><span class="status sent">Under Packaging</span></td>
      <td>
        <button class="action-btn dispatch" onclick="sendToFulfillment('${order.id}')">Packer(s)</button>
      </td>
    `;
    tbody.appendChild(row);
  });
}

function sendToFulfillment(orderId) {
  const orders = DataManager.getAllOrders();
  const order = orders.find(o => o.id === orderId);
  
  if (!order) {
    alert('Order not found');
    return;
  }
  
  order.status = 'awaiting-fulfillment';
  DataManager.saveOrders(orders);
  
  updateOrderCounts();
  renderPackagingQueue();
  alert('Order sent to Order Packaging');
}

function viewOrderDetails(orderId) {
  const orders = DataManager.getAllOrders();
  const order = orders.find(o => o.id === orderId);
  
  if (!order) {
    alert('Order not found');
    return;
  }
  
  const itemsHtml = order.items ? order.items.map(item => `
    <tr>
      <td>${item.name}</td>
      <td>${item.qty || 1}</td>
      <td>KES ${(item.price || 0).toLocaleString()}</td>
    </tr>
  `).join('') : '<tr><td colspan="3">No items</td></tr>';
  
  const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${order.id}`;
  
  const html = `
    <div style="text-align: center; margin-bottom: 20px;">
      <h3>Order Receipt</h3>
    </div>
    
    <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
      <p><strong>Customer Name:</strong> <span class="blurry-text">${order.customerName || 'N/A'}</span></p>
      <p><strong>Order ID:</strong> <span class="blurry-text">${order.id || 'N/A'}</span></p>
      <p><strong>Phone:</strong> <span class="blurry-text">${order.customerPhone || 'N/A'}</span></p>
      <p><strong>Status:</strong> <span class="blurry-text">${order.status || 'N/A'}</span></p>
      <p><strong>Delivery Location:</strong> <span class="blurry-text">${order.deliveryLocation || 'Pickup'}</span></p>
    </div>
    
    <h4>Order Items</h4>
    <table class="table">
      <thead>
        <tr>
          <th>Product</th>
          <th>Qty</th>
          <th>Price</th>
        </tr>
      </thead>
      <tbody>
        ${itemsHtml}
      </tbody>
    </table>
    
    <div style="text-align: center; margin-top: 20px;">
      <div class="blurry-text" style="display: inline-block;">
        <img src="${qrUrl}" style="width: 150px; height: 150px;">
        <div style="font-size: 14px; margin-top: 5px;">Scan to verify order details</div>
        <div style="font-size: 14px;">${order.id || 'N/A'}</div>
      </div>
    </div>
    
    <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #ddd;">
      <p><strong>Subtotal:</strong> KES ${(order.subtotal || 0).toLocaleString()}</p>
      <p><strong>Delivery Fee:</strong> KES ${(order.deliveryFee || 0).toLocaleString()}</p>
      <p><strong>Total:</strong> KES ${(order.grandTotal || order.totalPrice || 0).toLocaleString()}</p>
    </div>
    
    <div style="margin-top: 20px; display: flex; gap: 10px;">
      <button class="action-btn send" style="flex: 1; background: #16a34a;" onclick="sendToPackaging('${order.id}')"><i class="fas fa-check"></i> Send to Packaging & Dispatch</button>
      <button class="action-btn" style="flex: 1; background: #ccc; color: #000;" onclick="closeOrderDetailsModal()">Close</button>
    </div>
  `;
  
  document.getElementById('orderDetailsContent').innerHTML = html;
  document.getElementById('packagingModal').style.display = 'none';
  document.getElementById('orderDetailsModal').style.display = 'flex';
}

function closeOrderDetailsModal() {
  document.getElementById('orderDetailsModal').style.display = 'none';
}

function sendToPackaging(orderId) {
  const orders = DataManager.getAllOrders();
  const order = orders.find(o => o.id === orderId);
  
  if (!order) {
    alert('Order not found');
    return;
  }
  
  order.status = 'in-packaging';
  DataManager.saveOrders(orders);
  
  closeOrderDetailsModal();
  updateOrderCounts();
  renderPackagingQueue();
  alert('Order sent to Packaging & Dispatch Queue');
}

// Close modal on background click
window.onclick = function(event) {
  const packagingModal = document.getElementById('packagingModal');
  const detailsModal = document.getElementById('orderDetailsModal');
  
  if (event.target == packagingModal) {
    closePackagingModal();
  }
  if (event.target == detailsModal) {
    closeOrderDetailsModal();
  }
}
</script>



</body>
</html>