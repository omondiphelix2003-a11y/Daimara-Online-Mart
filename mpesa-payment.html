<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=1200">
<title>Daimara Online Mart | M-Pesa Payment</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Arial,sans-serif}
body{background:#f5f5f5; font-size: 22px; padding-bottom: 100px;}

/* FOOTER */
.footer {
  background: #0a0a0a;
  color: white;
  padding: 30px 20px;
  text-align: center;
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  z-index: 1000;
}
.footer p {
  color: rgb(233, 157, 17);
}

/* NAVBAR */
.navbar{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:15px 30px;
  background:#000000;
  color:#fff;
  position:fixed;
  top:0;
  width:100%;
  z-index:1000;
}
.logo{color:rgb(233,157,17);font-size:25px;font-weight:bold}
.navbar a{color:#f5f5f5;text-decoration:none;margin-left:15px;font-size: 25px;}
.navbar a:hover{color:rgb(233,157,17)}

.container{
  max-width:1000px;
  height: 500px;
  margin:120px auto 40px;
  padding:30px;
  background:#016422;
  border-radius:10px;
  box-shadow:0 5px 15px rgba(0,0,0,.1);
}

h2{text-align:center;margin-bottom:20px}

.mpesa-box{
  background:#888585;
  padding:20px;
  border-radius:8px;
  margin-bottom:20px;
}

.mpesa-box p{
  margin-bottom:10px;
  font-size:14px;
}

input{
  width:100%;
  padding:12px;
  margin:10px 0;
  border:1px solid #000000cc;
  border-radius:6px;
  box-shadow: #000000;
  background:#888585;
  cursor: pointer;
}

button{
  width:100%;
  padding:14px;
  background:#111;
  color:rgb(233,157,17);
  border:none;
  border-radius:6px;
  font-size:13px;
  cursor:pointer;
}

button:hover{
  background:#000;
}

.note{
  font-size:12px;
  color:#000000;
  text-align:center;
  margin-top:15px;
}
</style>
</head>

<body>

<!-- NAVBAR -->
<nav class="navbar">
  <div class="logo">
    <a href="home.html" style="color:inherit;text-decoration:none;">Daimara Online Mart</a>
  </div>
  <div>
    <a href="shop.html">Shop</a>
    <a href="cart.html"><i class="fa fa-shopping-cart"></i></a>
  </div>
</nav>

<footer class="footer">
  <p>Copyright © 2026 Daimara Online Mart.All rights reserved.</p>
</footer>

<div class="container">
  <h2>M-Pesa Payment</h2>

  <div class="mpesa-box">
    <p><strong>Order ID:</strong> <span id="orderId">—</span></p>
    <p><strong>Amount:</strong> KES <span id="amount">0</span></p>
  </div>

  <label for="phone">M-Pesa Phone Number</label>
  <input type="tel" id="phone" placeholder="2547XXXXXXXX" required>

  <button onclick="payNow()">
    <i class="fa fa-mobile-alt"></i> Pay with M-Pesa
  </button>

  <p class="note">
    You will receive an M-Pesa STK prompt on your phone.
  </p>
</div>

<script src="data-manager.js"></script>
<script>
const orderData = JSON.parse(localStorage.getItem('mpesaOrder'));

if(!orderData){
  alert("No order found");
  window.location.href = "checkout.html";
}

document.getElementById('orderId').innerText = orderData.orderId;
document.getElementById('amount').innerText = orderData.total;

// AUTO-FILL PHONE: First from logged-in user profile, then from localStorage
const loggedInUser = DataManager.getCurrentUser();
const savedPhone = localStorage.getItem('customerPhone');

if (loggedInUser && loggedInUser.phone) {
  document.getElementById('phone').value = loggedInUser.phone;
} else if (savedPhone) {
  document.getElementById('phone').value = savedPhone;
}

function payNow(){
  const phone = document.getElementById('phone').value.trim();

  if(!phone){
    alert("Please enter phone number");
    return;
  }

  localStorage.setItem('customerPhone', phone);

  console.log('Initiating M-Pesa payment for', phone, 'Amount:', orderData.total);
  
  // Simulate STK push
  alert("STK Push sent to " + phone + ". Please enter your PIN on your phone.");

  setTimeout(() => {
    alert("Payment successful! Thank you for shopping with Daimara Online Mart.");
    
    // REDUCE WAREHOUSE STOCK
    const warehouse = DataManager.getWarehouse();
    if (orderData.items) {
      orderData.items.forEach(item => {
        // Find product in warehouse by ID or Name
        const wProduct = warehouse.find(p => p.id === item.id || p.name === item.name);
        if (wProduct) {
          const newQty = Math.max(0, wProduct.quantity - (item.qty || 1));
          DataManager.updateWarehouseQuantity(wProduct.id, newQty);
        }
      });
    }

    // UPDATE ORDER STATUS TO COMPLETED
    const allOrders = DataManager.getAllOrders();
    const currentOrder = allOrders.find(o => o.id === orderData.orderId);
    if (currentOrder) {
      currentOrder.status = 'completed';
      DataManager.saveOrders(allOrders);
    }

    // Clear cart AFTER payment success
    if (typeof DataManager !== 'undefined') {
      DataManager.clearCart();
    }
    localStorage.removeItem('mpesaOrder');
    window.location.href = "home.html";
  }, 3000);
}
</script>

</body>
</html>
